<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<script>
materialsStr ='{"materials":[{"name":"UV_map","type":"single","texture":"textures/uv_grid_opengl.jpg"},{"name":"UV_6map","type":"array","texture1":"textures/uv_grid_opengl.jpg","texture2":"textures/uv_grid_opengl.jpg","texture3":"textures/uv_grid_opengl.jpg","texture4":"textures/uv_grid_opengl.jpg","texture5":"textures/uv_grid_opengl.jpg","texture6":"textures/uv_grid_opengl.jpg"},{"name":"dice","type":"array","texture1":"images/Dice-Blue-1.png","texture2":"images/Dice-Blue-2.png","texture3":"images/Dice-Blue-3.png","texture4":"images/Dice-Blue-4.png","texture5":"images/Dice-Blue-5.png","texture6":"images/Dice-Blue-6.png"},{"name":"dice2","type":"array","texture1":"images/Dice-Blue-1.png","texture2":"images/Dice-Blue-2.png","texture3":"images/Dice-Blue-3.png","texture4":"images/Dice-Blue-4.png","texture5":"images/Dice-Blue-5.png","texture6":"images/Dice-Blue-6.png"},{"name":"plywood6","type":"array","texture1":"textures/plywood_diff_1k.jpg","texture2":"textures/plywood_diff_1k.jpg","texture3":"textures/plywood_diff_1k.jpg","texture4":"textures/plywood_diff_1k.jpg","texture5":"textures/plywood_diff_1k.jpg","texture6":"textures/plywood_diff_1k.jpg"},{"name":"plywood","type":"single","texture":"textures/plywood_diff_1k.jpg"},{"name":"kitchen_wood","type":"single","texture":"textures/kitchen_wood_diff_1k.jpg"},{"name":"wood_table","type":"single","texture":"textures/wood_table_001_diff_1k.jpg"}]}';

materialOptionsStr = '{"materialOptions":[{"name":"materials ext","materials":[{"material":"plywood6"},{"material":"wood_table"},{"material":"kitchen_wood"},{"material":"UV_6map"},{"material":"dice"}]}]}';

designArmario1 = '{"parameters":[{"name":"largo","type":"cm","min":20,"max":400,"default":120},{"name":"alto","type":"cm","min":40,"max":250,"default":180},{"name":"profundidad","type":"cm","min":20,"max":120,"default":60},{"name":"espesor","type":"cm","min":1,"max":12,"default":3},{"name":"balda1","type":"cm","min":0,"max":200,"default":30}], "pieces":[{"name":"lado derecho","material":"dice","sx":"espesor","sy":"alto","sz":"profundidad","rx":0,"ry":0,"rz":0,"x":0,"y":0,"z":0},{"name":"lado izquierdo","material":"dice","sx":"espesor","sy":"alto","sz":"profundidad","rx":0,"ry":0,"rz":0,"x":"largo","y":0,"z":0},{"name":"centro","material":"dice","sx":"espesor","sy":"alto","sz":"profundidad","rx":0,"ry":0,"rz":0,"x":"largo/2","y":0,"z":0},{"name":"base","material":"dice","sx":"largo","sy":"espesor","sz":"profundidad","rx":0,"ry":0,"rz":0,"x":"0","y":0,"z":0},{"name":"tapa","material":"dice","sx":"largo","sy":"espesor","sz":"profundidad","rx":0,"ry":0,"rz":0,"x":"0","y":"alto","z":0},{"name":"balda","material":"dice","sx":"largo","sy":"espesor","sz":"profundidad","rx":0,"ry":0,"rz":0,"x":"0","y":"balda1","z":0}]}'
designArmarioXZ = '{"parameters":[{"name":"largo","type":"cm","min":20,"max":400,"default":120},{"name":"alto","type":"cm","min":40,"max":250,"default":180},{"name":"profundidad","type":"cm","min":20,"max":120,"default":60},{"name":"espesor","type":"cm","min":1,"max":12,"default":3},{"name":"balda1","type":"cm","min":0,"max":200,"default":30}], "pieces":[{"name":"lado derecho","material":"plywood6","sx":"espesor","sy":"profundidad","sz":"alto-espesor*2","rx":0,"ry":0,"rz":0,"x":0,"y":0,"z":"espesor"},{"name":"lado izquierdo","material":"plywood6","sx":"espesor","sy":"profundidad","sz":"alto-espesor*2","rx":0,"ry":0,"rz":0,"x":"largo-espesor","y":0,"z":"espesor"},{"name":"centro","material":"plywood6","sx":"espesor","sy":"profundidad","sz":"alto-espesor*2","rx":0,"ry":0,"rz":0,"x":"largo/2-espesor/2","y":0,"z":"espesor"},{"name":"base","material":"plywood6","sx":"largo","sy":"profundidad","sz":"espesor","rx":0,"ry":0,"rz":0,"x":"0","y":0,"z":0},{"name":"tapa","material":"plywood6","sx":"largo","sy":"profundidad","sz":"espesor","rx":0,"ry":0,"rz":0,"x":"0","y":"0","z":"alto-espesor"},{"name":"balda","material":"plywood6","sx":"largo/2-espesor*1.5","sy":"profundidad","sz":"espesor","rx":0,"ry":0,"rz":0,"x":"espesor","y":0,"z":"balda1"}]}'
designArmarioXZmaterialOptions = {
"name":"armario","parameters":[
          {"name":"largo_m1","type":"cm","min":20,"max":400,"default":60},
          {"name":"largo_modulo_cajones","type":"cm","min":20,"max":400,"default":60},
          {"name":"alto","type":"cm","min":40,"max":250,"default":180},
          {"name":"profundidad","type":"cm","min":20,"max":120,"default":60},
          {"name":"espesor","type":"cm","min":1,"max":12,"default":4},
          {"name":"espesor_cajon","type":"cm","min":1,"max":12,"default":2},
          {"name":"balda1","type":"cm","min":0,"max":200,"default":30},
          {"name":"balda_caj","type":"cm","min":0,"max":200,"default":0},
          {"name":"altura_cajonera","type":"m","min":0,"max":100,"default":60},
          {"name":"espaciado_vert","type":"cm","min":0,"max":10,"default":1},
          {"name":"espaciado_hor","type":"cm","min":0,"max":10,"default":1},
          {"name":"modulos","type":"m","min":0,"max":10,"default":3},
          {"name":"cajones","type":"m","min":0,"max":20,"default":6},
          {"name":"tiempo","type":"m","min":0,"max":300,"default":0}],
      "pieces":[
          {"name":"lado derecho","material":"plywood6","lx":"espesor","ly":"profundidad","lz":"alto-espesor*2","rx":0,"ry":0,"rz":0,"x":0,"y":0,"z":"espesor"},
          {"name":"lado izquierdo","array_size":"modulos","material":"plywood6","lx":"espesor","ly":"profundidad","lz":"alto-espesor*2","rx":0,"ry":0,"rz":0,"x":"largo_m1 + largo_modulo_cajones * (array_i + 1)-espesor","y":0,"z":"espesor"},
          {"name":"centro","material":"plywood6","lx":"espesor","ly":"profundidad","lz":"alto-espesor*2","rx":0,"ry":0,"rz":0,"x":"largo_m1-espesor","y":0,"z":"espesor"},
          {"name":"base","material":"plywood6","lx":"largo_m1 + largo_modulo_cajones * modulos","ly":"profundidad","lz":"espesor","rx":0,"ry":0,"rz":0,"x":"0","y":0,"z":0},
          {"name":"tapa","material":"plywood6","lx":"largo_m1 + largo_modulo_cajones * modulos","ly":"profundidad","lz":"espesor","rx":0,"ry":0,"rz":0,"x":"0","y":"0","z":"alto-espesor"},
          {"name":"fondo","material":"plywood6","lx":"largo_m1 + largo_modulo_cajones * modulos","ly":"espesor","lz":"alto","rx":0,"ry":0,"rz":0,"x":"0","y":"-espesor","z":"0"},
          {"name":"balda","material":"plywood6","lx":"largo_m1-espesor*2","ly":"profundidad","lz":"espesor","rx":0,"ry":0,"rz":0,"x":"espesor","y":0,"z":"balda1"},
          {"name":"balda cajones","array_size":"modulos","material":"plywood6","lx":"largo_modulo_cajones-espesor","ly":"profundidad","lz":"espesor","rx":0,"ry":0,"rz":0,"x":"largo_m1 + array_i*(largo_modulo_cajones)","y":0,"z":"(alto - 2*espesor)*altura_cajonera/100 + + espesor + espaciado_vert + balda_caj"},
          {"name":"subsystem array","subsystem":"cajonera","array_size":"modulos",
             "parameters":[
                  {"name":"largo","default":"largo_modulo_cajones - espesor - espaciado_hor*2"},
                  {"name":"alto","default":"(alto - 2*espesor)*altura_cajonera/100"},
                  {"name":"profundidad","default":"profundidad - espesor"},
                  {"name":"espaciado","default":"espaciado_vert"},
                  {"name":"espesor","default":"espesor_cajon"},
                  {"name":"cajones","default":"cajones"},
                  {"name":"tiempo","default":"tiempo"}
             ],"material":"plywood6","lx":"1","ly":"1","lz":"1","rx":0,"ry":0,"rz":0,"x":"largo_m1+array_i*(largo_modulo_cajones)+espaciado_hor","y":"0","z":"espesor"}
      ]}
design2pieces = '{"name":"2pieces","parameters":[{"name":"largo","type":"cm","min":20,"max":400,"default":120},{"name":"alto","type":"cm","min":40,"max":250,"default":180},{"name":"profundidad","type":"cm","min":20,"max":120,"default":60},{"name":"espesor","type":"cm","min":1,"max":12,"default":3},{"name":"balda1","type":"cm","min":0,"max":200,"default":30}], "pieces":[{"name":"base","material":"dice2","sx":"largo","sy":"profundidad","sz":"espesor","rx":0,"ry":0,"rz":0,"x":"0","y":0,"z":0},{"name":"cubo","material":"dice","sx":"largo/2","sy":"profundidad/2","sz":"alto/2","rx":0,"ry":0,"rz":0,"x":"largo/4","y":"profundidad/4","z":"alto/4"}]}'
design1Dice = '{"name":"cubo","parameters":[{"name":"largo","type":"cm","min":20,"max":400,"default":100},{"name":"alto","type":"cm","min":40,"max":250,"default":100},{"name":"profundidad","type":"cm","min":20,"max":200,"default":100},{"name":"balda1_sub","type":"cm","min":0,"max":200,"default":100}], "pieces":[{"name":"cubo","material":"dice","lx":"largo","ly":"profundidad","lz":"alto","rx":0,"ry":0,"rz":0,"x":"0","y":"0","z":"balda1_sub"}]}'
design4Dice = '{"name":"4cubo","parameters":[{"name":"largo","type":"cm","min":20,"max":400,"default":100},{"name":"alto","type":"cm","min":40,"max":250,"default":100},{"name":"profundidad","type":"cm","min":20,"max":200,"default":100},{"name":"balda1_sub","type":"cm","min":20,"max":200,"default":100}], "pieces":[{"name":"cubo","subsystem":"cubo","array_size":"5","parameters":[{"name":"largo","default":"largo/4"},{"name":"alto","default":"alto/4"},{"name":"profundidad","default":"profundidad/2"},{"name":"balda1_sub","default":"balda1_sub"}],"material":"dice","sx":"largo/2","sy":"profundidad/2","sz":"alto/2","rx":0,"ry":0,"rz":0,"x":"0","y":"0","z":"array_i*.2"}]}'

designCajon = {
"name":"cajon",
"parameters":[
    {"name":"largo","type":"cm","min":10,"max":400,"default":40},
    {"name":"alto","type":"cm","min":10,"max":100,"default":20},
    {"name":"profundidad","type":"cm","min":10,"max":120,"default":30},
    {"name":"espesor","type":"cm","min":0.5,"max":12,"default":2}
],
"pieces":[
    {"name":"lado derecho","material":"plywood6","lx":"espesor","ly":"profundidad - espesor","lz":"alto-espesor","rx":0,"ry":0,"rz":0,"x":0,"y":0,"z":"espesor"},
    {"name":"lado izquierdo","material":"plywood6","lx":"espesor","ly":"profundidad - espesor","lz":"alto-espesor","rx":0,"ry":0,"rz":0,"x":"largo-espesor","y":0,"z":"espesor"},
    {"name":"base","material":"kitchen_wood","lx":"largo","ly":"profundidad - espesor","lz":"espesor","rx":0,"ry":0,"rz":0,"x":"0","y":0,"z":0},
    {"name":"fondo","material":"plywood6","lx":"largo - espesor * 2","ly":"espesor","lz":"alto-espesor","rx":0,"ry":0,"rz":0,"x":"espesor","y":0,"z":"espesor"},
    {"name":"frente","material":"plywood6","lx":"largo","ly":"espesor","lz":"alto","rx":0,"ry":0,"rz":0,"x":"0","y":"profundidad - espesor","z":"0"},
    {"name":"tirador","material":"kitchen_wood","lx":"largo/10","ly":"espesor","lz":"alto/10","rx":0,"ry":0,"rz":0,"x":"largo/2-largo/10/2","y":"profundidad","z":"alto/2"}
]}
// temp to create a cajon with 1 piece: designCajon = '{"name":"cajon","parameters":[{"name":"largo","type":"cm","min":10,"max":400,"default":40},{"name":"alto","type":"cm","min":10,"max":100,"default":20},{"name":"profundidad","type":"cm","min":10,"max":120,"default":30},{"name":"espesor","type":"cm","min":0.5,"max":12,"default":2}], "pieces":[{"name":"base","material":"plywood6","lx":"largo","ly":"profundidad","lz":"espesor","rx":0,"ry":0,"rz":0,"x":"0","y":0,"z":0}]}'
designCajonera = '{"name":"cajonera","parameters":[{"name":"largo","type":"cm","min":20,"max":400,"default":100},{"name":"alto","type":"cm","min":40,"max":250,"default":200},{"name":"profundidad","type":"cm","min":20,"max":200,"default":100},{"name":"espesor","type":"cm","min":0.5,"max":12,"default":2},{"name":"espaciado","type":"cm","min":0,"max":10,"default":1},{"name":"cajones","type":"m","min":0,"max":20,"default":2},{"name":"tiempo","type":"m","min":0,"max":100,"default":0}], "pieces":[{"name":"cajon","subsystem":"cajon","array_size":"cajones","parameters":[{"name":"largo","default":"largo"},{"name":"alto","default":"(alto-espaciado*(cajones-1))/cajones"},{"name":"espesor","default":"espesor"},{"name":"profundidad","default":"profundidad"}],"material":"dice","lx":"1","ly":"1","lz":"1","rx":0,"ry":0,"rz":0,"x":"0","y":"ramp(array_i*10,array_i*10+25,100+array_i*10,100+array_i*10+25,tiempo)*profundidad*0.8","z":"array_i*(alto-espaciado*(cajones-1))/cajones+array_i*espaciado"}]}'
design2Cajoneras = '{"name":"2cajoneras","parameters":[{"name":"largo","type":"cm","min":20,"max":400,"default":50},{"name":"alto","type":"cm","min":6,"max":250,"default":40},{"name":"profundidad","type":"cm","min":20,"max":200,"default":100},{"name":"espesor","type":"cm","min":0.5,"max":12,"default":2},{"name":"espaciado","type":"cm","min":0,"max":10,"default":1},{"name":"cajoneras","type":"m","min":0,"max":20,"default":2},{"name":"cajones","type":"m","min":0,"max":20,"default":3}], "pieces":[{"name":"subsystem array","subsystem":"cajonera","array_size":"cajoneras","parameters":[{"name":"largo","default":"largo"},{"name":"alto","default":"alto"},{"name":"profundidad","default":"profundidad"},{"name":"espaciado","default":"espaciado"},{"name":"espesor","default":"espesor"},{"name":"cajones","default":"3"}],"material":"plywood6","lx":"1","ly":"1","lz":"1","rx":0,"ry":0,"rz":0,"x":"espesor + largo + largo/2 + array_i*largo*1.2","y":"0","z":"0"}]}'
//designStr = designArmario1;
designStr = designArmarioXZ;
//designStr = designArmarioXZmaterialOptions;
//designStr = design2pieces;
designStr = design1Dice;
//designObj = JSON.parse(designStr);
/* array alternative
designArr = [];
designArr[0] = JSON.parse(design1Dice);
designArr[1] = JSON.parse(designArmarioXZmaterialOptions);
*/
designArr = {};
obj = JSON.parse(design1Dice);
designArr[obj.name] = obj;
obj = JSON.parse(design4Dice);
designArr[obj.name] = obj;
obj = JSON.parse(design2pieces);
designArr[obj.name] = obj;
obj = designArmarioXZmaterialOptions;
designArr[obj.name] = obj;
obj = designCajon;
designArr[obj.name] = obj;
obj = JSON.parse(designCajonera);
designArr[obj.name] = obj;
obj = JSON.parse(design2Cajoneras);
designArr[obj.name] = obj;
designObj = designArr["2pieces"];
designObj = designArr["4cubo"];
designObj = designArr["cubo"];
designObj = designArr["2cajoneras"];
designObj = designArr["cajonera"];
designObj = designArr["cajon"];
designObj = designArr["armario"];

materialsObj = JSON.parse(materialsStr);
materialOptionsObj = JSON.parse(materialOptionsStr);

function ramp(a,b,c,d,t) {
  //  1               --------
  //                 /        \
  //                /          \
  //               /            \
  //  0 -----------              -----------
  //              a   b      c   d          
  
  if (t <= a) return 0;
  else if (t <= b) return (t - a)/(b-a);
  else if (t < c) return 1;
  else if (t <= d) return 1 - (t - c)/(d-c);
  else return 0;
}
</script>


  <style id="compiled-css" type="text/css">
      body {
      margin: 0;
}
    /* EOS */
  </style>

  <script id="insert"></script>


</head>
<body>
    <!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<!-- <script async="" src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script> -->
<!--<script async="" src="dist/es-module-shims.js"></script>-->
    
<script type="importmap">
    {
        "imports": {
            //"three": "https://unpkg.com/three/build/three.module.js"
            "three": "./three/build/three.module.js"
        }
    }
</script>

<script type="module">//<![CDATA[


    import * as THREE from 'three';

    import { GUI } from './jsm/libs/lil-gui.module.min.js';
    import { OrbitControls } from './jsm/controls/OrbitControls.js';

    let mesh, renderer, scene, camera;

    let gui;

    const API = {
        offsetX: 0,
        offsetY: 0,
        repeatX: 1.,
        repeatY: 1.,
        rotation: 0,  //Math.PI / 4, // positive is counter-clockwise
        centerX: 0.0,
        centerY: 0.0,
    };
    const settings = {
        debug: false,
        axes: true,
        UV: false,
    };
    for (var i =0; i< designObj.parameters.length; i++) {
        API[designObj.parameters[i].name] = designObj.parameters[i].default;
    }

    var geometry;
    var material_UV;
    var materialArray;
    var axesHelper;
    var evalText;

    init();
    

    function init() {

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.getElementById('renderDiv').appendChild( renderer.domElement );

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, .1, 1000 );
        camera.position.set( 2, 3, 1.6 );
        camera.up.set(0,0,1)   // z up (https://stackoverflow.com/questions/44630265/how-can-i-set-z-up-coordinate-system-in-three-js)
        scene.add( camera );

        const controls = new OrbitControls( camera, renderer.domElement );
        controls.addEventListener( 'change', render );
        controls.minDistance = 1;
        controls.maxDistance = 50;
        controls.maxPolarAngle = Math.PI / 2 * 1.5;


        const light = new THREE.DirectionalLight( 0xffffff, .8 );
        light.position.x = 5;
        light.position.y = 6;
        light.position.z = 7;
        scene.add( light );
        const light2 = new THREE.DirectionalLight( 0xffffff, .8 );
        light2.position.x = -2;
        light2.position.y = 2;
        light2.position.z = .5;
        scene.add( light2 );
        const light3 = new THREE.DirectionalLight( 0xffffff, .8 );
        light3.position.x = .5;
        light3.position.y = .5;
        light3.position.z = -.5;
        scene.add( light3 );
        const light4 = new THREE.DirectionalLight( 0xffffff, 1.3 );
        light4.position.x = -2;
        light4.position.y = -2;
        light4.position.z = .5;
        scene.add( light4 );
        //const helper = new THREE.DirectionalLightHelper( light4, 5 );
        //scene.add( helper );
        
        for (var i =0; i< materialsObj.materials.length; i++) {
            console.log("Material: " + materialsObj.materials[i].name);
            if (materialsObj.materials[i].type == "single") {
                var texture = new THREE.TextureLoader().load( materialsObj.materials[i].texture, function ( texture ) {
                    render();
                } );
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
                texture.matrixAutoUpdate = false; // default true; set to false to update texture.matrix manually
                //var meshMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff, map: texture } );
                var meshMaterial = new THREE.MeshStandardMaterial( { map: texture });
                //var meshMaterial = new THREE.MeshBasicMaterial( { map: texture } );
                //material_UV = material;  // tmp
                materialsObj.materials[i].material = meshMaterial;
            } else {  // array
                materialArray = [];
                texture = loadTexture(materialsObj.materials[i].texture1);
                texture = loadTexture(materialsObj.materials[i].texture2);
                texture = loadTexture(materialsObj.materials[i].texture3);
                texture = loadTexture(materialsObj.materials[i].texture4);
                texture = loadTexture(materialsObj.materials[i].texture5);
                texture = loadTexture(materialsObj.materials[i].texture6);
                materialsObj.materials[i].material = materialArray;
            }
            if (materialsObj.materials[i].name == "UV_6map") {
                material_UV = materialArray;
            }
        }

//        addDesign(scene, designObj);
        
        axesHelper = new THREE.AxesHelper( 4 );
        axes();
        scene.add( axesHelper );
        

        updateMeasures();
        updateUvTransform();
        
        initGui();

        render();

        window.addEventListener( 'resize', onWindowResize );

    }
    function visibility(arg) {
        console.log("visibility: " + arg + " " + this.property);
        getPiece(this.property).array[0].mesh.visible = arg;
        render();
    }
    /*function createSimplePoint(THREE) {
        var geometry = new THREE.BufferGeometry();
        const vertices = [];
        vertices.push(new THREE.Vector3( 0, 0, 0));
        //geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( vertices, 3 ) );
        var dot = new THREE.Points(geometry, new THREE.PointsMaterial( { color: 0x888888 } ) );
        return dot;
    }
    */
    function loadTexture(file) {
    
    
        var texture = new THREE.TextureLoader().load( file,function (º) {
            //meshMaterial.needsUpdate = true;
            render();
        } )
        //var meshMaterial = new THREE.MeshBasicMaterial( { map: texture });
        //var meshMaterial = new THREE.MeshStandardMaterial( { map: texture });
        var meshMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff, map: texture } );
        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
        texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
        texture.matrixAutoUpdate = false;
        materialArray.push(meshMaterial);
        return texture;
    }

    function updateMeasures(){
        evalText = "";
        for (var i =0; i< designObj.parameters.length; i++) {
            if (designObj.parameters[i].type == "m") {
                evalText = evalText + designObj.parameters[i].name + "=" + Number(API[designObj.parameters[i].name]) + ";";
            } else {  // cm
                evalText = evalText + designObj.parameters[i].name + "=" + Number(API[designObj.parameters[i].name])/100 + ";";
            }
        }
        //designObj.eval = makeEvalContext ("var context='main';" + evalText);
        designObj.evalText = "var context='main';" + evalText;
        updateMeasuresAPI(scene, THREE, API, designObj);
        updateUvTransform();
        render();
    }

    function updateMaterial(){
        updateMaterialDesign(designObj);
        render();
    }
    function updateMaterialDesign(updateMaterialDesignObj){
        console.log("updateMaterial");
        for (var i =0; i< materialOptionsObj.materialOptions.length; i++) {
            console.log(API[materialOptionsObj.materialOptions[i].name]);
        }
        for (var i = 0; i< updateMaterialDesignObj.pieces.length; i++) {
            if ('subsystem' in updateMaterialDesignObj.pieces[i]) {
                updateMaterialDesign(designArr[updateMaterialDesignObj.pieces[i].subsystem])
            } else {
                updateMaterialDesignObj.pieces[i].array[0].mesh.material=getMaterial(API[materialOptionsObj.materialOptions[0].name]).material;
            }
        }
        return; 
    }
    


    function render() {
        renderer.render( scene, camera );
    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;

        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

        render();

    }

    

    function debug() {
        console.debug("debug: " + settings.debug);
        debugger;
    }
    function axes(arg) {
        console.debug("axes: " + settings.axes);
        console.debug("axes arg: " + arg);
        axesHelper.visible = settings.axes;
        render();
    }
    function setUV() {
        console.debug("setUV: " + settings.UV);
        setUVSubsystem(designObj);
        render();
    }
    function setUVSubsystem(designSubsystem) {
        if (settings.UV) {
            for (var i = 0; i< designSubsystem.pieces.length; i++) {
                for (var array_i = 0; array_i < designSubsystem.pieces[i].array.length ; array_i++) {
                    designSubsystem.pieces[i].array[array_i].mesh.materialOriginal = designSubsystem.pieces[i].array[array_i].mesh.material;
                    designSubsystem.pieces[i].array[array_i].mesh.material=material_UV;
                    if ('subsystem' in designSubsystem.pieces[i]) {
                        setUVSubsystem(designSubsystem.pieces[i].array[array_i].subsystemDesign);
                    }
                }
            }
        } else {
            for (var i = 0; i< designSubsystem.pieces.length; i++) {
                for (var array_i = 0; array_i < designSubsystem.pieces[i].array.length ; array_i++) {
                    designSubsystem.pieces[i].array[array_i].mesh.material = designSubsystem.pieces[i].array[array_i].mesh.materialOriginal;
                    if ('subsystem' in designSubsystem.pieces[i]) {
                        setUVSubsystem(designSubsystem.pieces[i].array[array_i].subsystemDesign);
                    }
                }
            }
//                    designSubsystem.pieces[0].mesh.material=materialArray;
        }
    }
    function initGui() {

        gui = new GUI();

        for (var i =0; i< designObj.parameters.length; i++) {
            gui.add( API, designObj.parameters[i].name, designObj.parameters[i].min, designObj.parameters[i].max).step(1).name( designObj.parameters[i].name ).onChange( updateMeasures);
        }
        
        if (materialOptionsObj.materialOptions != null) {
            for (var i =0; i< materialOptionsObj.materialOptions.length; i++) {
                var materialOption = materialOptionsObj.materialOptions[i];
                console.log("materialOptions: " + materialOption.name);
                var materialOptionsArr = [];
                for (var j =0; j< materialOption.materials.length; j++) {
                    console.log("  material: " + materialOption.materials[j].material);
                    materialOptionsArr.push(materialOption.materials[j].material);
                }
                materialOption.materialOptionsArr = materialOptionsArr;
                API[materialOption.name] = materialOption.materials[0].material;
                gui.add( API, materialOption.name, materialOptionsArr ).onChange( updateMaterial);
            }
        }

        const textureFolder = gui.addFolder( 'texture properties' );
        textureFolder.close();
        textureFolder.add( API, 'offsetX', 0.0, 1.0 ).name( 'offset.x' ).onChange( updateUvTransform );
        textureFolder.add( API, 'offsetY', 0.0, 1.0 ).name( 'offset.y' ).onChange( updateUvTransform );
        textureFolder.add( API, 'repeatX', 0.25, 2.0 ).name( 'repeat.x' ).onChange( updateUvTransform );
        textureFolder.add( API, 'repeatY', 0.25, 2.0 ).name( 'repeat.y' ).onChange( updateUvTransform );
        textureFolder.add( API, 'rotation', - 2.0, 2.0 ).name( 'rotation' ).onChange( updateUvTransform );
        textureFolder.add( API, 'centerX', 0.0, 1.0 ).name( 'center.x' ).onChange( updateUvTransform );
        textureFolder.add( API, 'centerY', 0.0, 1.0 ).name( 'center.y' ).onChange( updateUvTransform );
        
        const settingsFolder = gui.addFolder( 'settings' );
        settingsFolder.open();
        settingsFolder.add( settings, 'debug' ).onChange( debug );
        settingsFolder.add( settings, 'axes' ).onChange( axes );
        settingsFolder.add( settings, 'UV' ).onChange( setUV );

        const piecesFolder = gui.addFolder( 'Pieces' );
        piecesFolder.open();
        for (var i =0; i< designObj.pieces.length; i++) {
            console.log("Piece: " + designObj.pieces[i].name);
            //gui
            API[designObj.pieces[i].name] = true;
            piecesFolder.add( API, designObj.pieces[i].name).onChange( visibility);
            /*
            piecesFolder.add( API, designObj.pieces[i].name).onChange(
                function(){
                  var yourVar = this.getValue();
                  console.log("yourVar: " + yourVar);
                }
            )
            */
        }


    }


  //]]></script>

<script>
/*
            function makeEvalContext (declarations) {
                // https://stackoverflow.com/questions/9781285/specify-scope-for-eval-in-javascript
                eval(declarations);
                return function (str) {return eval(str); }
            }
*/
</script>
<script>
            function getMaterial(name) {
                for (var i =0; i< materialsObj.materials.length; i++) {
                    if (name == materialsObj.materials[i].name) {
                        return materialsObj.materials[i];
                    }
                }
                return null;  // name not found 
            }
            function getPiece(name) {
                for (var i =0; i< designObj.pieces.length; i++) {
                    if (name == designObj.pieces[i].name) {
                        return designObj.pieces[i];
                    }
                }
                return null;  // name not found 
            }
            
            function isObject(obj) {
                return obj != null && obj.constructor.name === "Object"
            }
            function isMesh(obj) {
                return obj != null && obj.constructor.name === "Mesh"
            }
            function isPoint(obj) {
                return obj != null && obj.constructor.name === "Points"
            }
            function updateMeasuresAPI(node, THREE, API, updateDesign){
//                updateDesign.eval = makeEvalContext ();
//                updateDesign.eval(evalText);
                eval(updateDesign.evalText);    // initial evalText
                console.log("eval " + updateDesign.name + " " + updateDesign.evalText);
                for (var i =0; i< updateDesign.pieces.length; i++) {

                    // we define the parameters of the subsystem with the values of the updateDesign, but will apply them to the subsystem (before the call to updateMeasuresAPI.
                    var subsetEvalText = "";
                    if ('subsystem' in updateDesign.pieces[i]) {
                        for (var j =0; j< updateDesign.pieces[i].parameters.length; j++) {
                                subsetEvalText = subsetEvalText + updateDesign.pieces[i].parameters[j].name + "=" + Number(eval(updateDesign.pieces[i].parameters[j].default)) + ";";
                        }
                    }

                    var array_length;
                    if ('array_size' in updateDesign.pieces[i]) {
                        array_length = Math.round(eval(updateDesign.pieces[i].array_size));
                    } else {
                        array_length = 1;
                    }
                    if (updateDesign.pieces[i].array == null) {
                        console.log("Create array for piece " + i + " array_length: " + array_length + " " + updateDesign.name);
                        updateDesign.pieces[i].array = [];
                    }
                  //for (var array_i = 0; array_i < updateDesign.pieces[i].array.length ; array_i++) {
                    for (var array_j = array_length; array_j < updateDesign.pieces[i].array.length ; array_j++) {
                        console.log("Change visibilit of " + i + " array: " + array_j);
                        updateDesign.pieces[i].array[array_j].mesh.visible = false;
                    }
                    for (var array_i = 0; array_i < array_length ; array_i++) {
                        if (!isObject(updateDesign.pieces[i].array[array_i])) {
                            console.log("Create object " + array_i);
                            updateDesign.pieces[i].array[array_i] = {}
                        }
                        updateDesign.pieces[i].array[array_i].evalText = updateDesign.evalText + "array_i = " + array_i + ";" + "array_n = " + array_length + ";";
                        console.log("eval piece " + i + " "  + updateDesign.name + " evalText: " + updateDesign.pieces[i].array[array_i].evalText);
                        eval(updateDesign.pieces[i].array[array_i].evalText);
                        if ('subsystem' in updateDesign.pieces[i]) {
                            var dot;
                            if (!isPoint(updateDesign.pieces[i].array[array_i].mesh)) {
                                console.log("Create mesh dot");
                                dot = createSimplePoint(THREE);
                                updateDesign.pieces[i].array[array_i].mesh=dot;
                                if (node == null) debugger;
                                node.add( dot );
                                var clonedDesign = JSON.parse(JSON.stringify(designArr[updateDesign.pieces[i].subsystem]));
                                updateDesign.pieces[i].array[array_i].subsystemDesign = clonedDesign;
                            } else {
                                dot = updateDesign.pieces[i].array[array_i].mesh;
                            }
                          //addDesign(dot, updateDesign.pieces[i].array[array_i].subsystemDesign);
                            updateDesign.pieces[i].array[array_i].mesh.position.set(
                                   Number(eval(updateDesign.pieces[i].x)),
                                   Number(eval(updateDesign.pieces[i].y)), 
                                   Number(eval(updateDesign.pieces[i].z)));

                            updateDesign.pieces[i].array[array_i].subsystemDesign.evalText = "context='" +  
                              updateDesign.pieces[i].name +"';" + subsetEvalText;  // only their parameters, not array_i
                            console.log("eval piece " + i + " array_i: " + array_i 
                              + " subsystem: " + updateDesign.pieces[i].subsystem
                              + " evalText: " + updateDesign.pieces[i].array[array_i].subsystemDesign.evalText);
                            updateMeasuresAPI(dot, THREE, API, updateDesign.pieces[i].array[array_i].subsystemDesign);
                            eval(updateDesign.evalText);    // restore evalText
                        } else {
                            if (!isMesh(updateDesign.pieces[i].array[array_i].mesh)) {
                                console.log("Create mesh geometry");
                                geometry = new THREE.BoxGeometry( 1., 1., 1. );
                                //geometry = new THREE.BoxGeometry( eval(updateDesign.pieces[i].lx), eval(updateDesign.pieces[i].ly), eval(updateDesign.pieces[i].lz));
                                mesh = new THREE.Mesh( geometry, getMaterial(updateDesign.pieces[i].material).material );
                                updateDesign.pieces[i].array[array_i].mesh=mesh;
                                node.add( mesh );
                            }
                            updateDesign.pieces[i].array[array_i].mesh.position.set(
                                   Number(eval(updateDesign.pieces[i].lx)/2) + Number(eval(updateDesign.pieces[i].x)),
                                   Number(eval(updateDesign.pieces[i].ly)/2) + Number(eval(updateDesign.pieces[i].y)), 
                                   Number(eval(updateDesign.pieces[i].lz)/2) + Number(eval(updateDesign.pieces[i].z)));
                        }
                        updateDesign.pieces[i].array[array_i].mesh.visible = true;

                        // Set default values if non exist
                        if (!('sx' in updateDesign.pieces[i])) updateDesign.pieces[i].sx=1;
                        if (!('sy' in updateDesign.pieces[i])) updateDesign.pieces[i].sy=1;
                        if (!('sz' in updateDesign.pieces[i])) updateDesign.pieces[i].sz=1;
                        updateDesign.pieces[i].array[array_i].mesh.scale.set( eval(updateDesign.pieces[i].lx), eval(updateDesign.pieces[i].ly), eval(updateDesign.pieces[i].lz));
                        if (updateDesign.pieces[i].array[array_i].mesh.geometry.type == "BoxGeometry") {
                            //scale texture
                            //we change the uv coordinates of the geometry, so the same texture can be applied to different faces and different pieces
                            //Float32Array(48) [0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,
                            //                 000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647
                            uva= updateDesign.pieces[i].array[array_i].mesh.geometry.getAttribute("uv").array;
                            // face 1 (X=1) (1,1,1) 0, 1, 1, 1, 0, 0, 1, 0,
                            //Face 1
                            var ini = 0;
                            uva[ini + 1] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 2] = eval(updateDesign.pieces[i].lz);
                            uva[ini + 3] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 6] = eval(updateDesign.pieces[i].lz);
                            //Face 2
                            var ini = ini + 8;
                            uva[ini + 1] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 2] = eval(updateDesign.pieces[i].lz);
                            uva[ini + 3] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 6] = eval(updateDesign.pieces[i].lz);
                            //Face 3
                            var ini = ini + 8;
                            uva[ini + 1] = eval(updateDesign.pieces[i].lz);
                            uva[ini + 2] = eval(updateDesign.pieces[i].lx);
                            uva[ini + 3] = eval(updateDesign.pieces[i].lz);
                            uva[ini + 6] = eval(updateDesign.pieces[i].lx);
                            //Face 4
                            var ini = ini + 8;
                            uva[ini + 1] = eval(updateDesign.pieces[i].lz);
                            uva[ini + 2] = eval(updateDesign.pieces[i].lx);
                            uva[ini + 3] = eval(updateDesign.pieces[i].lz);
                            uva[ini + 6] = eval(updateDesign.pieces[i].lx);
                            //Face 5
                            var ini = ini + 8;
                            uva[ini + 1] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 2] = eval(updateDesign.pieces[i].lx);
                            uva[ini + 3] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 6] = eval(updateDesign.pieces[i].lx);
                            //Face 6
                            var ini = ini + 8;
                            uva[ini + 1] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 2] = eval(updateDesign.pieces[i].lx);
                            uva[ini + 3] = eval(updateDesign.pieces[i].ly);
                            uva[ini + 6] = eval(updateDesign.pieces[i].lx);
                            updateDesign.pieces[i].array[array_i].mesh.geometry.getAttribute("uv").needsUpdate = true;
                        }
                            
                    }
                }
            }
            function createSimplePoint(THREE) {
                var geometry = new THREE.BufferGeometry();
                const vertices = [];
                vertices.push(new THREE.Vector3( 0, 0, 0));
                //geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( vertices, 3 ) );
                var dot = new THREE.Points(geometry, new THREE.PointsMaterial( { color: 0x888888 } ) );
                return dot;
            }

            function updateUvTransform(arg) {
                return;
                //if (!settings.UV) return;
                for (var i =0; i< designObj.pieces.length; i++) {
                    var texture;
                    materialObj = getMaterial(designObj.pieces[i].material);
                    if (materialObj.type == "single") { 
                        texture = designObj.pieces[i].mesh.material.map;
                        texture.matrix.identity().scale( updateDesign.eval(designObj.pieces[i].sx), updateDesign.eval(designObj.pieces[i].sy), updateDesign.eval(designObj.pieces[i].sz) )
                    } else {
//                        for (var j =0; j< 6; j++) {
/*                            texture = designObj.pieces[i].mesh.material[0].map;
                            texture.matrix.identity().scale( eval(designObj.pieces[i].sz), eval(designObj.pieces[i].sy))
                            texture = designObj.pieces[i].mesh.material[1].map;
                            texture.matrix.identity().scale( eval(designObj.pieces[i].sz), eval(designObj.pieces[i].sy))
                            texture = designObj.pieces[i].mesh.material[2].map;
                            texture.matrix.identity().scale( eval(designObj.pieces[i].sx), eval(designObj.pieces[i].sz))
                            texture = designObj.pieces[i].mesh.material[3].map;
                            texture.matrix.identity().scale( eval(designObj.pieces[i].sx), eval(designObj.pieces[i].sz))
                            texture = designObj.pieces[i].mesh.material[4].map;
                            texture.matrix.identity().scale( eval(designObj.pieces[i].sx), eval(designObj.pieces[i].sy))
                            texture = designObj.pieces[i].mesh.material[5].map;
                            texture.matrix.identity().scale( eval(designObj.pieces[i].sx), eval(designObj.pieces[i].sy))
*/
//                        }
                    }
                }


/*
                    if (settings.UV) {
                        texture = designObj.pieces[0].mesh.material.map;
                    } else {
                        texture = designObj.pieces[0].mesh.material[4].map;
                    }
*/
/*
                    if ( texture.matrixAutoUpdate === true ) {

                        texture.offset.set( API.offsetX, API.offsetY );
                        texture.repeat.set( API.repeatX, API.repeatY );
                        texture.center.set( API.centerX, API.centerY );
                        texture.rotation = API.rotation; // rotation is around [ 0.5, 0.5 ]

                    } else {

                        // one way...
                        //texture.matrix.setUvTransform( API.offsetX, API.offsetY, API.repeatX, API.repeatY, API.rotation, API.centerX, API.centerY );

                        // another way...
                        texture.matrix
                            .identity()
                            //.translate( - API.centerX,- API.centerY, 0 )
                            //.rotate( API.rotation )					// I don't understand how rotation can preceed scale, but it seems to be required...
                            //.scale( API.repeatX, API.repeatY, API.repeatZ )
    //                   designObj.pieces[i].mesh.scale.set( eval(designObj.pieces[i].sx), eval(designObj.pieces[i].sy), eval(designObj.pieces[i].sz));

                            .scale( eval(designObj.pieces[i].sx), eval(designObj.pieces[i].sy), eval(designObj.pieces[i].sz) )
                        //    .translate( API.centerX, API.centerY )
                            //.translate( API.offsetX, 0, 0 )
                            ;

                    }
                }
*/


            }

</script>

  <script>
    // tell the embed parent frame the height of the content
    if (window.parent && window.parent.parent){
      window.parent.parent.postMessage(["resultsFrame", {
        height: document.body.getBoundingClientRect().height,
        slug: "7u84j6kp"
      }], "*")
    }

    // always overwrite window.name, in case users try to set it manually
    window.name = "result"
  </script>



<div id='renderDiv'></div>
<h3>Version 1.7</h3>
<h3>Previous versions</h3>
<br><a href=escene10.html>v 10</a> Include Subsystems
<br><a href=escene11.html>v 11</a> Subsystems with evalText for each subsystem
<br><a href=escene12.html>v 12</a> Arrays
<br><a href=escene13.html>v 13</a> Arrays con limites variables
<br><a href=escene15.html>v 15</a> Remove addDesign and create objects and arrays in updateMeasuresAPI
<br><a href=escene16.html>v 16</a> Change sx, xy, sz to lx, ly, lz
<br><a href=escene17.html>v 17</a> Corregir error de parametro en subsistema - Demo con cajoneras y cajones
<br><a href=escene18.html>v 18</a> Corregir error de parametro en subsistema - Ejemplo armario y 5 cajoneras
<br><a href=escene19.html>v 19</a> Ejemplo armario, para comprobar subsystem
<br><a href=escene19b.html>v 19b</a> Ejemplo armario, para comprobar sin subsystem
<br><a href=escene20b.html>v 20b</a> Corregir evalText para que solo haya un contexto y las variables del nivel (que no se repitan variables)
<br><a href=escene21.html>v 21</a> Pruebas armario
<br><a href=escene22.html>v 22</a> Ejemplo armario
<br><a href=escene23.html>v 23</a> Ejemplo armario con cajon con frontal y fondo
<br><a href=escene24.html>v 24</a> Arrays i, j, k
  <script>
document.write("parameters: " + designObj.parameters.length);
document.write("pieces: " + designObj.pieces.length);
  </script>
</body></html>
